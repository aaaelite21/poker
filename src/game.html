<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Poker Game</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<h1 id="code"></h1>
<div id="clock">00:00</div>
<div class="action-buttons">
    <button id="start-btn" style="display:none">Start Clock</button>
    <button id="pause-btn" style="display:none">Pause Clock</button>
    <button id="restart-btn" style="display:none">Restart Level</button>
    <button id="assign-btn" style="display:none">Assign Seats</button>
    <button id="share-btn" style="display:none">Share</button>
</div>
<div id="level-info" style="text-align:center;margin-bottom:10px">
    <div>Current: <span id="current-level"></span></div>
    <div>Next: <span id="next-level"></span></div>
</div>
<table id="players"></table>
<div id="pot"></div>
<h2>History</h2>
<ul id="history"></ul>
<div id="qr-container" style="display:none;text-align:center">
    <img id="qr" alt="QR Code">
</div>
<script src="config.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const url = new URL(window.location);
const code = url.searchParams.get('code');
const playerId = url.searchParams.get('player');
const adminToken = localStorage.getItem('adminToken');
const startBtn = document.getElementById('start-btn');
const pauseBtn = document.getElementById('pause-btn');
const restartBtn = document.getElementById('restart-btn');
const assignBtn = document.getElementById('assign-btn');
const shareBtn = document.getElementById('share-btn');
const qrImg = document.getElementById('qr');
const qrContainer = document.getElementById('qr-container');
const currentEl = document.getElementById('current-level');
const nextEl = document.getElementById('next-level');

let timer = null;
let timeRemaining = 0;
let currentLevel = 0;
let blindLevels = [];
let config = {};
let startTime = null;
let pausedAt = null;
const base = window.PUBLIC_URL || window.location.origin;
qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' +
    encodeURIComponent(base + '/game.html?code=' + code);
shareBtn.style.display = 'inline-block';
if(adminToken){
    startBtn.style.display = 'inline-block';
    pauseBtn.style.display = 'inline-block';
    restartBtn.style.display = 'inline-block';
    assignBtn.style.display = 'inline-block';
}
function updateButtons(){
    if(!adminToken) return;
    if(!startTime){
        startBtn.textContent = 'Start Clock';
    }else if(pausedAt){
        startBtn.textContent = 'Resume Clock';
    }else{
        startBtn.textContent = 'Start Clock';
    }
}
updateButtons();
startBtn.addEventListener('click', async () => {
    const res = await fetch('/api/start/'+code,{method:'POST',headers:{'Authorization':adminToken}});
    const out = await res.json();
    if(out.error) alert(out.error);
    else updateButtons();
});
pauseBtn.addEventListener('click', async () => {
    const res = await fetch('/api/pause/'+code,{method:'POST',headers:{'Authorization':adminToken}});
    const out = await res.json();
    if(out.error) alert(out.error);
    else updateButtons();
});
restartBtn.addEventListener('click', async () => {
    const res = await fetch('/api/restart-level/'+code,{method:'POST',headers:{'Authorization':adminToken}});
    const out = await res.json();
    if(out.error) alert(out.error);
});
assignBtn.addEventListener('click', async () => {
    const res = await fetch('/api/assign-seats/'+code,{method:'POST',headers:{'Authorization':adminToken}});
    const out = await res.json();
    if(out.error) alert(out.error);
});

shareBtn.addEventListener('click', () => {
    qrContainer.style.display = qrContainer.style.display === 'none' ? 'block' : 'none';
});

document.getElementById('code').textContent = 'Game Code: '+code;
const socket = io();
socket.emit('joinRoom', code);

socket.on('update', game => {
    render(game);
});
socket.on('start', data => {
    startTime = data.startTime;
    pausedAt = null;
    computeTime();
    startClock();
    updateButtons();
});
socket.on('pause', data => {
    pausedAt = data.pausedAt;
    computeTime();
    updateClock();
    if(timer){
        clearInterval(timer);
        timer = null;
    }
    updateButtons();
});

async function fetchGame(){
    const res = await fetch('/api/game/'+code);
    const game = await res.json();
    config = game.config;
    blindLevels = config.levels;
    startTime = game.startTime || null;
    pausedAt = game.pausedAt || null;
    if(startTime){
        computeTime();
    }else{
        timeRemaining = config.duration;
    }
    render(game);
    updateClock();
    updateButtons();
}

function updateClock(){
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    document.getElementById('clock').textContent = `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
    if(blindLevels.length){
        const cur = blindLevels[currentLevel] || {};
        const next = blindLevels[currentLevel+1] || {};
        currentEl.textContent = cur.bigBlind ? `${cur.bigBlind}/${cur.littleBlind}` : 'N/A';
        nextEl.textContent = next.bigBlind ? `${next.bigBlind}/${next.littleBlind}` : 'N/A';
    }
}

function computeTime(){
    if(startTime!==null){
        const now = pausedAt || Date.now();
        const elapsed = Math.floor((now - startTime)/1000);
        currentLevel = Math.floor(elapsed / config.duration);
        if(currentLevel >= blindLevels.length) currentLevel = blindLevels.length-1;
        timeRemaining = config.duration - (elapsed % config.duration);
    }
}

function nextLevel(){
    if(currentLevel < blindLevels.length-1){
        currentLevel++;
        timeRemaining = config.duration;
    }
}

function startClock(){
    if(!timer){
        timer = setInterval(()=>{
            computeTime();
            updateClock();
        },1000);
    }
}

function render(game){
    const table = document.getElementById('players');
    const header = '<tr><th>Seat</th><th>Name</th><th>Status</th><th>Rebuys</th><th></th></tr>';
    const rows = game.players.map(p => {
        const status = p.busted ? 'Busted' : 'In';
        let btn = '';
        if(adminToken){
            btn = `<button class="toggle" data-id="${p.id}">${p.busted?'Unbust':'Bust'}</button>`;
        } else if(p.id === playerId){
            btn = `<button class="toggle" data-id="${p.id}">${p.busted?'Unbust':'I\'m Busted'}</button>`;
        }
        return `<tr><td>${p.seat??''}</td><td>${p.name}</td><td>${status}</td><td>${p.rebuys}</td><td>${btn}</td></tr>`;
    }).join('');
    table.innerHTML = header + rows;
    table.querySelectorAll('.toggle').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const player = game.players.find(p => p.id===id);
            const headers = {'Content-Type':'application/json'};
            if(adminToken) headers['Authorization'] = adminToken;
            else headers['Player-Id'] = playerId;
            await fetch(`/api/bust/${code}/${id}`,{method:'POST',headers,body:JSON.stringify({busted:!player.busted})});
        });
    });
    const pot = (game.players.length * game.config.buyin) + game.players.reduce((s,p)=>s+p.rebuys*game.config.buyin,0);
    document.getElementById('pot').textContent = 'Total Pot $'+pot;
    const historyList = game.history.map(h => {
        const t = new Date(h.time).toLocaleTimeString();
        return `<li>${t} - ${h.msg}</li>`;
    }).join('');
    document.getElementById('history').innerHTML = historyList;
}

fetchGame().then(() => { if(startTime) startClock(); });
</script>
</body>
</html>
